---
# =============================================================================
# Playbook: Complete Server Lifecycle Management
# =============================================================================
# Purpose:     Automate the full server lifecycle from bare-metal to 
#              production-ready, including monitoring and decommissioning.
#
# Phase:       Run (Advanced)
# Risk Level:  HIGH - Comprehensive server management operations
#
# Lifecycle Stages:
#   1. PROVISION - Create profiles and policies
#   2. DEPLOY - Apply configuration to hardware
#   3. VERIFY - Confirm successful deployment
#   4. DECOMMISSION - Clean removal when end-of-life
#
# Usage:
#   # Full lifecycle (provision + deploy)
#   ansible-playbook playbooks/run/03_lifecycle_management.yml --ask-vault-pass \
#     -e "lifecycle_stage=provision"
#
#   # Decommission a server
#   ansible-playbook playbooks/run/03_lifecycle_management.yml --ask-vault-pass \
#     -e "lifecycle_stage=decommission" \
#     -e "target_server_name=WebServer-01"
# =============================================================================

- name: Complete Server Lifecycle Management
  hosts: localhost
  connection: local
  gather_facts: true
  
  vars:
    # Lifecycle stage: provision, deploy, verify, decommission
    lifecycle_stage: "provision"
    
    # Server configuration (for provisioning)
    server_config:
      name: "Ansible-Managed-Server"
      serial: ""  # Must be provided for assignment
      description: "Server provisioned and managed by Ansible"
      role: "general"
      environment: "production"
      
    # Policies to use
    policies:
      boot: "Ansible-Boot-LocalDisk"
      bios: "Ansible-BIOS-VirtualizationOptimized"
      storage: "Ansible-Storage-Default"
      
    # Organization
    target_organization: "default"
    
    # Decommissioning options
    decommission_options:
      delete_profile: true
      unassign_only: false  # If true, just unassign without deleting
      
    # For targeting specific server (decommission)
    target_server_name: ""
    
  tasks:
    # =========================================================================
    # HEADER
    # =========================================================================
    - name: Display lifecycle operation
      ansible.builtin.debug:
        msg: |
          
          ╔══════════════════════════════════════════════════════════════════════════════╗
          ║                    SERVER LIFECYCLE MANAGEMENT                                ║
          ╠══════════════════════════════════════════════════════════════════════════════╣
          ║                                                                               ║
          ║  Stage:       {{ lifecycle_stage | upper | center(58) }} ║
          ║  Time:        {{ ansible_date_time.iso8601 | center(58) }} ║
          ║                                                                               ║
          ╚══════════════════════════════════════════════════════════════════════════════╝
          
          Lifecycle Stages:
          ─────────────────────────────────────────────────────────────────────────────────
          
            ┌──────────────┐    ┌──────────────┐    ┌──────────────┐    ┌──────────────┐
            │  PROVISION   │────│    DEPLOY    │────│    VERIFY    │────│ DECOMMISSION │
            └──────────────┘    └──────────────┘    └──────────────┘    └──────────────┘
                  │                   │                   │                    │
                  ▼                   ▼                   ▼                    ▼
             Create profile      Apply config       Health checks        Cleanup and
             Attach policies     to hardware        Validate state       remove profile
          
          ─────────────────────────────────────────────────────────────────────────────────
          
    # =========================================================================
    # COMMON SETUP
    # =========================================================================
    - name: Query organization
      cisco.intersight.intersight_rest_api:
        api_private_key: "{{ intersight_api_private_key }}"
        api_key_id: "{{ intersight_api_key_id }}"
        api_uri: "{{ intersight_api_uri }}"
        resource_path: /organization/Organizations
        query_params:
          $filter: "Name eq '{{ target_organization }}'"
      register: org_query
      
    - name: Store organization Moid
      ansible.builtin.set_fact:
        org_moid: "{{ org_query.api_response.Results[0].Moid }}"
        
    # =========================================================================
    # STAGE: PROVISION
    # =========================================================================
    - name: "PROVISION: Create server profile"
      when: lifecycle_stage == "provision"
      block:
        - name: Query policies
          cisco.intersight.intersight_rest_api:
            api_private_key: "{{ intersight_api_private_key }}"
            api_key_id: "{{ intersight_api_key_id }}"
            api_uri: "{{ intersight_api_uri }}"
            resource_path: "{{ item.path }}"
            query_params:
              $filter: "Name eq '{{ item.name }}'"
          register: policy_queries
          loop:
            - { path: "/boot/PrecisionPolicies", name: "{{ policies.boot }}", type: "boot" }
            - { path: "/bios/Policies", name: "{{ policies.bios }}", type: "bios" }
            - { path: "/storage/StoragePolicies", name: "{{ policies.storage }}", type: "storage" }
          loop_control:
            label: "{{ item.type }}"
            
        - name: Create server profile
          cisco.intersight.intersight_rest_api:
            api_private_key: "{{ intersight_api_private_key }}"
            api_key_id: "{{ intersight_api_key_id }}"
            api_uri: "{{ intersight_api_uri }}"
            resource_path: /server/Profiles
            state: present
            update_method: patch
            
            api_body:
              Name: "{{ server_config.name }}"
              Description: "{{ server_config.description }}"
              TargetPlatform: "Standalone"
              
              Organization:
                Moid: "{{ org_moid }}"
                ObjectType: organization.Organization
                
              PolicyBucket:
                - Moid: "{{ policy_queries.results[0].api_response.Results[0].Moid }}"
                  ObjectType: boot.PrecisionPolicy
                - Moid: "{{ policy_queries.results[1].api_response.Results[0].Moid }}"
                  ObjectType: bios.Policy
                - Moid: "{{ policy_queries.results[2].api_response.Results[0].Moid }}"
                  ObjectType: storage.StoragePolicy
                  
              Tags:
                - Key: "CreatedBy"
                  Value: "Ansible-Lifecycle"
                - Key: "Role"
                  Value: "{{ server_config.role }}"
                - Key: "Environment"
                  Value: "{{ server_config.environment }}"
                - Key: "LifecycleStage"
                  Value: "provisioned"
                - Key: "ProvisionedAt"
                  Value: "{{ ansible_date_time.iso8601 }}"
                  
          register: provision_result
          
        - name: Display provisioning result
          ansible.builtin.debug:
            msg: |
              
              ╔══════════════════════════════════════════════════════════════════════════════╗
              ║                    PROVISION STAGE COMPLETE                                   ║
              ╠══════════════════════════════════════════════════════════════════════════════╣
              ║                                                                               ║
              ║  Profile Created: {{ server_config.name | center(56) }} ║
              ║  Profile Moid:    {{ provision_result.api_response.Moid | center(56) }} ║
              ║                                                                               ║
              ║  Attached Policies:                                                           ║
              ║  • Boot Policy:    {{ policies.boot }}
              ║  • BIOS Policy:    {{ policies.bios }}
              ║  • Storage Policy: {{ policies.storage }}
              ║                                                                               ║
              ╠══════════════════════════════════════════════════════════════════════════════╣
              ║  NEXT STEP                                                                    ║
              ║  ───────────────────────────────────────────────────────────────────────────  ║
              ║  Assign a physical server and deploy:                                         ║
              ║                                                                               ║
              ║  ansible-playbook ... -e "lifecycle_stage=deploy"                             ║
              ║                        -e "target_server_name={{ server_config.name }}"      ║
              ║                        -e "server_config.serial=FCH12345678"                  ║
              ║                                                                               ║
              ╚══════════════════════════════════════════════════════════════════════════════╝
              
    # =========================================================================
    # STAGE: DEPLOY
    # =========================================================================
    - name: "DEPLOY: Apply profile to server"
      when: lifecycle_stage == "deploy"
      block:
        - name: Query target profile
          cisco.intersight.intersight_rest_api:
            api_private_key: "{{ intersight_api_private_key }}"
            api_key_id: "{{ intersight_api_key_id }}"
            api_uri: "{{ intersight_api_uri }}"
            resource_path: /server/Profiles
            query_params:
              $filter: "Name eq '{{ target_server_name | default(server_config.name) }}'"
          register: target_profile
          
        - name: Validate profile exists
          ansible.builtin.fail:
            msg: "Profile '{{ target_server_name | default(server_config.name) }}' not found. Run provision stage first."
          when: target_profile.api_response.Results | length == 0
          
        - name: Query physical server
          cisco.intersight.intersight_rest_api:
            api_private_key: "{{ intersight_api_private_key }}"
            api_key_id: "{{ intersight_api_key_id }}"
            api_uri: "{{ intersight_api_uri }}"
            resource_path: /compute/PhysicalSummaries
            query_params:
              $filter: "Serial eq '{{ server_config.serial }}'"
          register: physical_server
          when: server_config.serial != ""
          
        - name: Assign server to profile
          cisco.intersight.intersight_rest_api:
            api_private_key: "{{ intersight_api_private_key }}"
            api_key_id: "{{ intersight_api_key_id }}"
            api_uri: "{{ intersight_api_uri }}"
            resource_path: "/server/Profiles/{{ target_profile.api_response.Results[0].Moid }}"
            state: present
            update_method: patch
            
            api_body:
              AssignedServer:
                Moid: "{{ physical_server.api_response.Results[0].Moid }}"
                ObjectType: "{{ physical_server.api_response.Results[0].SourceObjectType }}"
                
          register: assign_result
          when: 
            - server_config.serial != ""
            - physical_server.api_response.Results | length > 0
            
        - name: Trigger profile deployment
          cisco.intersight.intersight_rest_api:
            api_private_key: "{{ intersight_api_private_key }}"
            api_key_id: "{{ intersight_api_key_id }}"
            api_uri: "{{ intersight_api_uri }}"
            resource_path: "/server/Profiles/{{ target_profile.api_response.Results[0].Moid }}"
            state: present
            update_method: patch
            
            api_body:
              Action: "Deploy"
              
          register: deploy_result
          when: assign_result is succeeded
          
        - name: Display deployment status
          ansible.builtin.debug:
            msg: |
              
              ╔══════════════════════════════════════════════════════════════════════════════╗
              ║                    DEPLOY STAGE INITIATED                                     ║
              ╠══════════════════════════════════════════════════════════════════════════════╣
              ║                                                                               ║
              ║  Profile:    {{ target_server_name | default(server_config.name) }}
              ║  Server:     {{ physical_server.api_response.Results[0].Name }}
              ║  Serial:     {{ server_config.serial }}
              ║                                                                               ║
              ║  ⏳ Deployment in progress...                                                 ║
              ║                                                                               ║
              ║  Monitor progress:                                                            ║
              ║  1. Intersight UI: Profiles > {{ target_server_name | default(server_config.name) }}
              ║  2. Wait for ConfigState to show 'Associated'                                 ║
              ║                                                                               ║
              ╚══════════════════════════════════════════════════════════════════════════════╝
              
    # =========================================================================
    # STAGE: VERIFY
    # =========================================================================
    - name: "VERIFY: Check deployment status"
      when: lifecycle_stage == "verify"
      block:
        - name: Query profile status
          cisco.intersight.intersight_rest_api:
            api_private_key: "{{ intersight_api_private_key }}"
            api_key_id: "{{ intersight_api_key_id }}"
            api_uri: "{{ intersight_api_uri }}"
            resource_path: /server/Profiles
            query_params:
              $filter: "Name eq '{{ target_server_name }}'"
              $select: "Name,ConfigState,TargetPlatform,AssignedServer"
          register: profile_status
          
        - name: Display verification result
          ansible.builtin.debug:
            msg: |
              
              ╔══════════════════════════════════════════════════════════════════════════════╗
              ║                    VERIFICATION RESULT                                        ║
              ╠══════════════════════════════════════════════════════════════════════════════╣
              ║                                                                               ║
              ║  Profile: {{ target_server_name }}
              ║  Status:  {{ profile_status.api_response.Results[0].ConfigState | default('Unknown') }}
              ║                                                                               ║
              {% if profile_status.api_response.Results[0].ConfigState == 'Associated' %}
              ║  ✅ SERVER IS PRODUCTION READY                                                ║
              {% else %}
              ║  ⏳ Deployment still in progress or issue detected                            ║
              {% endif %}
              ║                                                                               ║
              ╚══════════════════════════════════════════════════════════════════════════════╝
              
    # =========================================================================
    # STAGE: DECOMMISSION
    # =========================================================================
    - name: "DECOMMISSION: Remove server profile"
      when: lifecycle_stage == "decommission"
      block:
        - name: Confirm decommission
          ansible.builtin.pause:
            prompt: |
              
              ⚠️  DECOMMISSION CONFIRMATION
              
              You are about to decommission: {{ target_server_name }}
              
              This will:
              1. Unassign the server from its profile
              {% if decommission_options.delete_profile %}2. Delete the server profile{% endif %}
              
              Press ENTER to continue or Ctrl+C, then 'A' to abort
              
        - name: Query profile to decommission
          cisco.intersight.intersight_rest_api:
            api_private_key: "{{ intersight_api_private_key }}"
            api_key_id: "{{ intersight_api_key_id }}"
            api_uri: "{{ intersight_api_uri }}"
            resource_path: /server/Profiles
            query_params:
              $filter: "Name eq '{{ target_server_name }}'"
          register: decomm_profile
          
        - name: Unassign server from profile
          cisco.intersight.intersight_rest_api:
            api_private_key: "{{ intersight_api_private_key }}"
            api_key_id: "{{ intersight_api_key_id }}"
            api_uri: "{{ intersight_api_uri }}"
            resource_path: "/server/Profiles/{{ decomm_profile.api_response.Results[0].Moid }}"
            state: present
            update_method: patch
            
            api_body:
              Action: "Unassign"
              
          when: decomm_profile.api_response.Results | length > 0
          
        - name: Delete profile
          cisco.intersight.intersight_rest_api:
            api_private_key: "{{ intersight_api_private_key }}"
            api_key_id: "{{ intersight_api_key_id }}"
            api_uri: "{{ intersight_api_uri }}"
            resource_path: /server/Profiles
            state: absent
            moid: "{{ decomm_profile.api_response.Results[0].Moid }}"
            
          when: 
            - decomm_profile.api_response.Results | length > 0
            - decommission_options.delete_profile
            
        - name: Display decommission result
          ansible.builtin.debug:
            msg: |
              
              ╔══════════════════════════════════════════════════════════════════════════════╗
              ║                    DECOMMISSION COMPLETE                                      ║
              ╠══════════════════════════════════════════════════════════════════════════════╣
              ║                                                                               ║
              ║  Server profile '{{ target_server_name }}' has been decommissioned.
              ║                                                                               ║
              ║  Actions taken:                                                               ║
              ║  ✅ Server unassigned from profile                                            ║
              {% if decommission_options.delete_profile %}
              ║  ✅ Profile deleted                                                           ║
              {% endif %}
              ║                                                                               ║
              ╚══════════════════════════════════════════════════════════════════════════════╝
