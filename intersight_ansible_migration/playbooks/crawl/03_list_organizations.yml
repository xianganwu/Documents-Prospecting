---
# =============================================================================
# Playbook: List Intersight Organizations
# =============================================================================
# Purpose:     Query and display all organizations in your Intersight account.
#              Organizations are used to segment resources and control access.
#
# Phase:       Crawl (Beginner)
# Risk Level:  None - Read-only operation
#
# What You'll Learn:
#   - How organizations work in Intersight
#   - How to query the organization/Organizations endpoint
#   - How to use registered variables in subsequent tasks
#   - How to set facts for use later in a playbook
#
# Usage:
#   ansible-playbook playbooks/crawl/03_list_organizations.yml --ask-vault-pass
#
# Why Organizations Matter:
#   - They segment your infrastructure (Production, Dev, DR, etc.)
#   - They control who can access what resources
#   - Policies and profiles are scoped to organizations
#   - You'll need to specify organizations when creating resources
# =============================================================================

- name: List Intersight Organizations
  hosts: localhost
  connection: local
  gather_facts: false
  
  tasks:
    # =========================================================================
    # TASK 1: Query All Organizations
    # =========================================================================
    # The organization/Organizations endpoint returns all orgs you have access to
    # =========================================================================
    - name: Query all organizations from Intersight
      cisco.intersight.intersight_rest_api:
        api_private_key: "{{ intersight_api_private_key }}"
        api_key_id: "{{ intersight_api_key_id }}"
        api_uri: "{{ intersight_api_uri }}"
        
        # Organizations endpoint
        resource_path: /organization/Organizations
        
        query_params:
          # Get all organizations (usually not many)
          $top: 100
          $orderby: "Name asc"
          
      register: organizations
      
    # =========================================================================
    # TASK 2: Store Organization List for Later Use
    # =========================================================================
    # set_fact creates a variable that persists through the playbook.
    # This is useful for passing data between plays or for simplifying
    # complex expressions.
    # =========================================================================
    - name: Store organization list as a fact
      ansible.builtin.set_fact:
        org_list: "{{ organizations.api_response.Results }}"
        org_count: "{{ organizations.api_response.Results | length }}"
        
    # =========================================================================
    # TASK 3: Display Organization Overview
    # =========================================================================
    - name: Display organization overview
      ansible.builtin.debug:
        msg: |
          
          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘                    INTERSIGHT ORGANIZATIONS                                   â•‘
          â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
          â•‘  Total Organizations: {{ org_count | string | center(56) }} â•‘
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          Understanding Organizations:
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          â€¢ Organizations provide multi-tenancy in Intersight
          â€¢ Resources (servers, policies, profiles) belong to organizations
          â€¢ Role-Based Access Control (RBAC) is scoped to organizations
          â€¢ You can have shared resources or organization-specific ones
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    # =========================================================================
    # TASK 4: Display Each Organization
    # =========================================================================
    - name: Display organization details
      ansible.builtin.debug:
        msg: |
          
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          â”‚ ORGANIZATION: {{ item.Name }}
          â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          â”‚  Description:     {{ item.Description | default('No description') }}
          â”‚  Moid:           {{ item.Moid }}
          â”‚  
          â”‚  Resource Groups:
          â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          {% if item.ResourceGroups is defined and item.ResourceGroups | length > 0 %}
          {% for rg in item.ResourceGroups %}
          â”‚    â€¢ {{ rg.Moid }} (Use for filtering resources)
          {% endfor %}
          {% else %}
          â”‚    (No explicit resource groups - using defaults)
          {% endif %}
          â”‚
          â”‚  Created:        {{ item.CreateTime | default('N/A') }}
          â”‚  Modified:       {{ item.ModTime | default('N/A') }}
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      loop: "{{ org_list }}"
      loop_control:
        label: "{{ item.Name }}"
        
    # =========================================================================
    # TASK 5: Find Default Organization
    # =========================================================================
    # The 'default' organization always exists and is commonly used
    # =========================================================================
    - name: Identify the default organization
      ansible.builtin.set_fact:
        default_org: "{{ org_list | selectattr('Name', 'equalto', 'default') | list | first | default({}) }}"
        
    - name: Display default organization info
      ansible.builtin.debug:
        msg: |
          
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          DEFAULT ORGANIZATION
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          The 'default' organization is special:
          â€¢ It's created automatically for every Intersight account
          â€¢ It's often used for shared resources
          â€¢ New resources go here if no organization is specified
          
          Default Org Moid: {{ default_org.Moid | default('Not found') }}
          
          ğŸ’¡ TIP: Save this Moid value! You'll need it when creating policies.
          
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      when: default_org | length > 0
      
    # =========================================================================
    # TASK 6: Create Organization Mapping for Reference
    # =========================================================================
    # Creates a simple name-to-moid mapping for easy reference
    # =========================================================================
    - name: Create organization name-to-moid mapping
      ansible.builtin.set_fact:
        org_mapping: "{{ org_mapping | default({}) | combine({item.Name: item.Moid}) }}"
      loop: "{{ org_list }}"
      loop_control:
        label: "{{ item.Name }}"
        
    - name: Display organization mapping
      ansible.builtin.debug:
        msg: |
          
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          ORGANIZATION REFERENCE (Copy these for your playbooks)
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          Add this to your group_vars/all.yml for easy organization reference:
          
          ```yaml
          # Organization Moid Reference
          organizations:
          {% for name, moid in org_mapping.items() %}
            {{ name }}: "{{ moid }}"
          {% endfor %}
          ```
          
          Usage in playbooks:
            Organization:
              - Moid: "{{ organizations.default }}"
                ObjectType: organization.Organization
          
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    # =========================================================================
    # TASK 7: Summary and Next Steps
    # =========================================================================
    - name: Display next steps
      ansible.builtin.debug:
        msg: |
          
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          âœ… CRAWL PHASE COMPLETE!
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          You have successfully:
          â˜‘ Tested API connectivity
          â˜‘ Retrieved server inventory
          â˜‘ Listed all organizations
          
          What you've learned:
          â€¢ How to authenticate with the Intersight API
          â€¢ How to query different API endpoints
          â€¢ How to process and display API responses
          â€¢ How organizations work in Intersight
          
          Ready for the next phase? Move on to:
          ğŸ‘‰ Walk Phase: docs/04_walk_phase.md
          
          In the Walk Phase, you'll:
          â€¢ Create boot policies
          â€¢ Configure BIOS settings
          â€¢ Build server profiles
          â€¢ Make actual configuration changes (in test org first!)
          
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
